// tests/frontend/modals/dock-audit-modals.test.js
// Comprehensive tests for dock audit modal components and workflows

import React from 'react';
import { render, screen, fireEvent, waitFor, within } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { BrowserRouter } from 'react-router-dom';
import DockAuditModal from '../../../src/frontend/src/components/modals/DockAuditModal';\nimport ReceivingAuditModal from '../../../src/frontend/src/components/modals/ReceivingAuditModal';\nimport ShippingAuditModal from '../../../src/frontend/src/components/modals/ShippingAuditModal';\nimport { AppProvider } from '../../../src/frontend/src/contexts/AppContext';\nimport apiClient from '../../../src/frontend/src/services/api-client';\n\n// Mock the API client\njest.mock('../../../src/frontend/src/services/api-client');\n\n// Mock file reading for photo/signature capture\nObject.defineProperty(global.File.prototype, 'arrayBuffer', {\n  value: jest.fn().mockResolvedValue(new ArrayBuffer(8))\n});\n\nObject.defineProperty(global.FileReader.prototype, 'readAsDataURL', {\n  value: jest.fn(function() {\n    this.result = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD';\n    this.onload();\n  })\n});\n\n// Mock HTML5 Canvas for signature pad\nObject.defineProperty(HTMLCanvasElement.prototype, 'getContext', {\n  value: jest.fn(() => ({\n    clearRect: jest.fn(),\n    beginPath: jest.fn(),\n    moveTo: jest.fn(),\n    lineTo: jest.fn(),\n    stroke: jest.fn(),\n    measureText: jest.fn(() => ({ width: 100 })),\n    fillText: jest.fn(),\n    drawImage: jest.fn(),\n    toDataURL: jest.fn(() => 'data:image/png;base64,signature-data')\n  }))\n});\n\n// Mock data\nconst mockPreadmission = {\n  id: 1,\n  admission_id: 'ADM-001',\n  status: 'Arrived',\n  customer_name: 'Customer A',\n  container_number: 'CONT-001',\n  e214: 'E214-001',\n  bol: 'BOL-001',\n  expected_arrival: '2024-01-15T10:00:00Z',\n  items: [\n    { part_number: 'PART-001', description: 'Test Part', expected_qty: 100, hts_code: '1234.56.78' },\n    { part_number: 'PART-002', description: 'Another Part', expected_qty: 50, hts_code: '8765.43.21' }\n  ]\n};\n\nconst mockPreshipment = {\n  id: 1,\n  shipment_id: 'SHIP-001',\n  status: 'Loading',\n  customer_name: 'Customer A',\n  line_items: [\n    { part_number: 'PART-001', lot_number: 'LOT-001', quantity: 100 },\n    { part_number: 'PART-002', lot_number: 'LOT-002', quantity: 75 }\n  ]\n};\n\n// Test wrapper component\nconst TestWrapper = ({ children }) => {\n  const queryClient = new QueryClient({\n    defaultOptions: {\n      queries: { retry: false },\n      mutations: { retry: false }\n    }\n  });\n\n  return (\n    <QueryClientProvider client={queryClient}>\n      <BrowserRouter>\n        <AppProvider>\n          {children}\n        </AppProvider>\n      </BrowserRouter>\n    </QueryClientProvider>\n  );\n};\n\ndescribe('Dock Audit Modal Components', () => {\n  beforeEach(() => {\n    // Reset API mocks\n    jest.clearAllMocks();\n\n    // Mock successful API responses\n    apiClient.preadmission = {\n      updateAudit: jest.fn().mockResolvedValue({ success: true }),\n      processAdmission: jest.fn().mockResolvedValue({ success: true, inventoryLot: { id: 'LOT-001' } })\n    };\n\n    apiClient.preshipment = {\n      finalizeShipment: jest.fn().mockResolvedValue({ success: true })\n    };\n  });\n\n  describe('DockAuditModal (General)', () => {\n    const defaultProps = {\n      isOpen: true,\n      onClose: jest.fn(),\n      preadmission: mockPreadmission,\n      mode: 'receiving'\n    };\n\n    it('should render modal with correct title', () => {\n      render(\n        <TestWrapper>\n          <DockAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      expect(screen.getByRole('dialog')).toBeInTheDocument();\n      expect(screen.getByText(/dock audit - receiving/i)).toBeInTheDocument();\n    });\n\n    it('should display admission information', () => {\n      render(\n        <TestWrapper>\n          <DockAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      expect(screen.getByText('ADM-001')).toBeInTheDocument();\n      expect(screen.getByText('Customer A')).toBeInTheDocument();\n      expect(screen.getByText('CONT-001')).toBeInTheDocument();\n      expect(screen.getByText('E214-001')).toBeInTheDocument();\n    });\n\n    it('should close modal when close button is clicked', async () => {\n      const user = userEvent.setup();\n      const onClose = jest.fn();\n      \n      render(\n        <TestWrapper>\n          <DockAuditModal {...defaultProps} onClose={onClose} />\n        </TestWrapper>\n      );\n\n      const closeButton = screen.getByRole('button', { name: /close/i });\n      await user.click(closeButton);\n\n      expect(onClose).toHaveBeenCalled();\n    });\n\n    it('should close modal when escape key is pressed', async () => {\n      const user = userEvent.setup();\n      const onClose = jest.fn();\n      \n      render(\n        <TestWrapper>\n          <DockAuditModal {...defaultProps} onClose={onClose} />\n        </TestWrapper>\n      );\n\n      await user.keyboard('{Escape}');\n      expect(onClose).toHaveBeenCalled();\n    });\n  });\n\n  describe('ReceivingAuditModal', () => {\n    const defaultProps = {\n      isOpen: true,\n      onClose: jest.fn(),\n      preadmission: mockPreadmission\n    };\n\n    it('should render item verification checklist', () => {\n      render(\n        <TestWrapper>\n          <ReceivingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      expect(screen.getByText('PART-001')).toBeInTheDocument();\n      expect(screen.getByText('PART-002')).toBeInTheDocument();\n      expect(screen.getByText(/expected: 100/i)).toBeInTheDocument();\n      expect(screen.getByText(/expected: 50/i)).toBeInTheDocument();\n    });\n\n    it('should allow quantity verification input', async () => {\n      const user = userEvent.setup();\n      \n      render(\n        <TestWrapper>\n          <ReceivingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      const qtyInputs = screen.getAllByLabelText(/received quantity/i);\n      await user.type(qtyInputs[0], '95');\n      await user.type(qtyInputs[1], '50');\n\n      expect(qtyInputs[0]).toHaveValue(95);\n      expect(qtyInputs[1]).toHaveValue(50);\n    });\n\n    it('should highlight quantity discrepancies', async () => {\n      const user = userEvent.setup();\n      \n      render(\n        <TestWrapper>\n          <ReceivingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      const qtyInput = screen.getAllByLabelText(/received quantity/i)[0];\n      await user.type(qtyInput, '95'); // 5 less than expected 100\n\n      // Should show discrepancy indicator\n      expect(screen.getByText(/discrepancy: -5/i)).toBeInTheDocument();\n      expect(qtyInput.closest('div')).toHaveClass('border-red-300');\n    });\n\n    it('should require seal number input', async () => {\n      const user = userEvent.setup();\n      \n      render(\n        <TestWrapper>\n          <ReceivingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      const approveButton = screen.getByRole('button', { name: /approve admission/i });\n      await user.click(approveButton);\n\n      expect(screen.getByText(/seal number is required/i)).toBeInTheDocument();\n    });\n\n    it('should validate skid count', async () => {\n      const user = userEvent.setup();\n      \n      render(\n        <TestWrapper>\n          <ReceivingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      const skidInput = screen.getByLabelText(/number of skids/i);\n      await user.type(skidInput, '-1');\n\n      expect(screen.getByText(/skid count must be positive/i)).toBeInTheDocument();\n    });\n\n    describe('Photo Upload', () => {\n      it('should allow photo upload', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ReceivingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        const photoInput = screen.getByLabelText(/upload photos/i);\n        const file = new File(['test'], 'dock-photo.jpg', { type: 'image/jpeg' });\n        \n        await user.upload(photoInput, file);\n\n        expect(screen.getByText('dock-photo.jpg')).toBeInTheDocument();\n      });\n\n      it('should validate photo file types', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ReceivingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        const photoInput = screen.getByLabelText(/upload photos/i);\n        const invalidFile = new File(['test'], 'document.pdf', { type: 'application/pdf' });\n        \n        await user.upload(photoInput, invalidFile);\n\n        expect(screen.getByText(/only image files are allowed/i)).toBeInTheDocument();\n      });\n\n      it('should limit photo file size', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ReceivingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        const photoInput = screen.getByLabelText(/upload photos/i);\n        const largeFile = new File(['x'.repeat(10 * 1024 * 1024)], 'large-photo.jpg', { type: 'image/jpeg' });\n        \n        await user.upload(photoInput, largeFile);\n\n        expect(screen.getByText(/file size must be less than 5MB/i)).toBeInTheDocument();\n      });\n\n      it('should allow multiple photo uploads', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ReceivingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        const photoInput = screen.getByLabelText(/upload photos/i);\n        const file1 = new File(['test1'], 'photo1.jpg', { type: 'image/jpeg' });\n        const file2 = new File(['test2'], 'photo2.jpg', { type: 'image/jpeg' });\n        \n        await user.upload(photoInput, [file1, file2]);\n\n        expect(screen.getByText('photo1.jpg')).toBeInTheDocument();\n        expect(screen.getByText('photo2.jpg')).toBeInTheDocument();\n      });\n    });\n\n    describe('Approval Workflow', () => {\n      it('should approve admission with valid data', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ReceivingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        // Fill in required fields\n        const sealInput = screen.getByLabelText(/seal number/i);\n        await user.type(sealInput, 'SEAL-123456');\n\n        const skidInput = screen.getByLabelText(/number of skids/i);\n        await user.type(skidInput, '3');\n\n        const notesInput = screen.getByLabelText(/audit notes/i);\n        await user.type(notesInput, 'All items verified and in good condition');\n\n        // Fill in quantities\n        const qtyInputs = screen.getAllByLabelText(/received quantity/i);\n        await user.type(qtyInputs[0], '100');\n        await user.type(qtyInputs[1], '50');\n\n        const approveButton = screen.getByRole('button', { name: /approve admission/i });\n        await user.click(approveButton);\n\n        await waitFor(() => {\n          expect(apiClient.preadmission.updateAudit).toHaveBeenCalledWith(\n            'ADM-001',\n            expect.objectContaining({\n              status: 'Approved',\n              seal_number: 'SEAL-123456',\n              skid_count: 3,\n              audit_notes: 'All items verified and in good condition',\n              admitted_items: expect.arrayContaining([\n                expect.objectContaining({ part_number: 'PART-001', qty: 100 }),\n                expect.objectContaining({ part_number: 'PART-002', qty: 50 })\n              ])\n            })\n          );\n        });\n      });\n\n      it('should reject admission with reason', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ReceivingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        const rejectButton = screen.getByRole('button', { name: /reject admission/i });\n        await user.click(rejectButton);\n\n        // Should show rejection reason input\n        const reasonInput = screen.getByLabelText(/rejection reason/i);\n        await user.type(reasonInput, 'Damaged container seal');\n\n        const confirmRejectButton = screen.getByRole('button', { name: /confirm rejection/i });\n        await user.click(confirmRejectButton);\n\n        await waitFor(() => {\n          expect(apiClient.preadmission.updateAudit).toHaveBeenCalledWith(\n            'ADM-001',\n            expect.objectContaining({\n              status: 'Rejected',\n              rejection_reason: 'Damaged container seal'\n            })\n          );\n        });\n      });\n\n      it('should require rejection reason when rejecting', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ReceivingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        const rejectButton = screen.getByRole('button', { name: /reject admission/i });\n        await user.click(rejectButton);\n\n        const confirmRejectButton = screen.getByRole('button', { name: /confirm rejection/i });\n        await user.click(confirmRejectButton);\n\n        expect(screen.getByText(/rejection reason is required/i)).toBeInTheDocument();\n      });\n    });\n\n    describe('Inventory Lot Creation', () => {\n      it('should proceed to lot creation after approval', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ReceivingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        // Complete approval process\n        await user.type(screen.getByLabelText(/seal number/i), 'SEAL-123');\n        await user.type(screen.getAllByLabelText(/received quantity/i)[0], '100');\n        await user.click(screen.getByRole('button', { name: /approve admission/i }));\n\n        await waitFor(() => {\n          // Should show lot creation step\n          expect(screen.getByText(/create inventory lots/i)).toBeInTheDocument();\n          expect(screen.getByText('PART-001')).toBeInTheDocument();\n        });\n      });\n\n      it('should require storage locations for lot creation', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ReceivingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        // Navigate to lot creation step (mock approved state)\n        // This would require component state manipulation or prop changes\n        // For now, assume we're in the lot creation step\n\n        const createLotsButton = screen.getByRole('button', { name: /create lots/i });\n        await user.click(createLotsButton);\n\n        expect(screen.getByText(/storage location is required/i)).toBeInTheDocument();\n      });\n\n      it('should create lots with specified locations', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ReceivingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        // Assume we're in the lot creation step\n        const locationInputs = screen.getAllByLabelText(/storage location/i);\n        await user.type(locationInputs[0], 'A-01-01');\n        await user.type(locationInputs[1], 'A-01-02');\n\n        const createLotsButton = screen.getByRole('button', { name: /create lots/i });\n        await user.click(createLotsButton);\n\n        await waitFor(() => {\n          expect(apiClient.preadmission.processAdmission).toHaveBeenCalledWith(\n            'ADM-001',\n            expect.objectContaining({\n              partId: 'PART-001',\n              location: 'A-01-01',\n              qty: 100\n            })\n          );\n        });\n      });\n    });\n  });\n\n  describe('ShippingAuditModal', () => {\n    const defaultProps = {\n      isOpen: true,\n      onClose: jest.fn(),\n      preshipment: mockPreshipment\n    };\n\n    it('should render shipping audit interface', () => {\n      render(\n        <TestWrapper>\n          <ShippingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      expect(screen.getByText(/shipping audit/i)).toBeInTheDocument();\n      expect(screen.getByText('SHIP-001')).toBeInTheDocument();\n    });\n\n    it('should display line items for verification', () => {\n      render(\n        <TestWrapper>\n          <ShippingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      expect(screen.getByText('PART-001')).toBeInTheDocument();\n      expect(screen.getByText('LOT-001')).toBeInTheDocument();\n      expect(screen.getByText('100')).toBeInTheDocument();\n    });\n\n    describe('Driver Information', () => {\n      it('should require driver information', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ShippingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        const finalizeButton = screen.getByRole('button', { name: /finalize shipment/i });\n        await user.click(finalizeButton);\n\n        expect(screen.getByText(/driver name is required/i)).toBeInTheDocument();\n        expect(screen.getByText(/license number is required/i)).toBeInTheDocument();\n        expect(screen.getByText(/license plate is required/i)).toBeInTheDocument();\n      });\n\n      it('should validate driver license format', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ShippingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        const licenseInput = screen.getByLabelText(/driver license number/i);\n        await user.type(licenseInput, '123'); // Too short\n\n        expect(screen.getByText(/license number must be at least 6 characters/i)).toBeInTheDocument();\n      });\n\n      it('should validate license plate format', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ShippingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        const plateInput = screen.getByLabelText(/license plate/i);\n        await user.type(plateInput, 'ABC123456789'); // Too long\n\n        expect(screen.getByText(/license plate must be 10 characters or less/i)).toBeInTheDocument();\n      });\n    });\n\n    describe('Signature Capture', () => {\n      it('should provide signature pad', () => {\n        render(\n          <TestWrapper>\n            <ShippingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        expect(screen.getByText(/driver signature/i)).toBeInTheDocument();\n        expect(screen.getByRole('button', { name: /clear signature/i })).toBeInTheDocument();\n      });\n\n      it('should require signature before finalizing', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ShippingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        // Fill required fields but no signature\n        await user.type(screen.getByLabelText(/driver name/i), 'John Doe');\n        await user.type(screen.getByLabelText(/driver license/i), 'DL123456');\n        await user.type(screen.getByLabelText(/license plate/i), 'ABC123');\n\n        const finalizeButton = screen.getByRole('button', { name: /finalize shipment/i });\n        await user.click(finalizeButton);\n\n        expect(screen.getByText(/driver signature is required/i)).toBeInTheDocument();\n      });\n\n      it('should clear signature when clear button is clicked', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ShippingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        const clearButton = screen.getByRole('button', { name: /clear signature/i });\n        await user.click(clearButton);\n\n        // Canvas context clearRect should be called\n        const canvas = document.querySelector('canvas');\n        expect(canvas.getContext().clearRect).toHaveBeenCalled();\n      });\n    });\n\n    describe('Shipment Finalization', () => {\n      it('should finalize shipment with complete information', async () => {\n        const user = userEvent.setup();\n        \n        render(\n          <TestWrapper>\n            <ShippingAuditModal {...defaultProps} />\n          </TestWrapper>\n        );\n\n        // Fill all required information\n        await user.type(screen.getByLabelText(/driver name/i), 'John Doe');\n        await user.type(screen.getByLabelText(/driver license/i), 'DL123456');\n        await user.type(screen.getByLabelText(/license plate/i), 'ABC123');\n        await user.type(screen.getByLabelText(/carrier name/i), 'Express Shipping');\n\n        // Mock signature (would be drawn on canvas in real usage)\n        const canvas = document.querySelector('canvas');\n        canvas.toDataURL = jest.fn(() => 'data:image/png;base64,signature-data');\n\n        const finalizeButton = screen.getByRole('button', { name: /finalize shipment/i });\n        await user.click(finalizeButton);\n\n        await waitFor(() => {\n          expect(apiClient.preshipment.finalizeShipment).toHaveBeenCalledWith(\n            'SHIP-001',\n            expect.objectContaining({\n              driver_name: 'John Doe',\n              driver_license_number: 'DL123456',\n              license_plate_number: 'ABC123',\n              carrier_name: 'Express Shipping',\n              signature_data: 'data:image/png;base64,signature-data'\n            })\n          );\n        });\n      });\n    });\n  });\n\n  describe('Error Handling', () => {\n    it('should handle API errors gracefully', async () => {\n      const user = userEvent.setup();\n      \n      apiClient.preadmission.updateAudit.mockRejectedValue(\n        new Error('Network error')\n      );\n\n      render(\n        <TestWrapper>\n          <ReceivingAuditModal {...{ ...defaultProps }} />\n        </TestWrapper>\n      );\n\n      // Fill form and submit\n      await user.type(screen.getByLabelText(/seal number/i), 'SEAL-123');\n      await user.click(screen.getByRole('button', { name: /approve admission/i }));\n\n      await waitFor(() => {\n        expect(screen.getByText(/network error/i)).toBeInTheDocument();\n      });\n    });\n\n    it('should handle file upload errors', async () => {\n      const user = userEvent.setup();\n      \n      // Mock FileReader error\n      Object.defineProperty(global.FileReader.prototype, 'readAsDataURL', {\n        value: jest.fn(function() {\n          this.onerror(new Error('File read error'));\n        })\n      });\n\n      render(\n        <TestWrapper>\n          <ReceivingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      const photoInput = screen.getByLabelText(/upload photos/i);\n      const file = new File(['test'], 'photo.jpg', { type: 'image/jpeg' });\n      \n      await user.upload(photoInput, file);\n\n      expect(screen.getByText(/failed to process file/i)).toBeInTheDocument();\n    });\n  });\n\n  describe('Accessibility', () => {\n    it('should have proper ARIA labels', () => {\n      render(\n        <TestWrapper>\n          <ReceivingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      expect(screen.getByRole('dialog')).toHaveAttribute('aria-modal', 'true');\n      expect(screen.getByRole('dialog')).toHaveAttribute('aria-labelledby');\n    });\n\n    it('should trap focus within modal', async () => {\n      const user = userEvent.setup();\n      \n      render(\n        <TestWrapper>\n          <ReceivingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      // First focusable element should be focused\n      expect(screen.getByLabelText(/seal number/i)).toHaveFocus();\n\n      // Tab should cycle through modal elements only\n      await user.tab();\n      expect(document.activeElement).toBeInTheDocument();\n      expect(document.activeElement.closest('[role=\"dialog\"]')).toBeInTheDocument();\n    });\n\n    it('should support keyboard navigation', async () => {\n      const user = userEvent.setup();\n      \n      render(\n        <TestWrapper>\n          <ReceivingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      // Enter should activate buttons\n      const approveButton = screen.getByRole('button', { name: /approve admission/i });\n      approveButton.focus();\n      await user.keyboard('{Enter}');\n\n      // Should show validation errors since form is incomplete\n      expect(screen.getByText(/seal number is required/i)).toBeInTheDocument();\n    });\n  });\n\n  describe('Performance', () => {\n    it('should not re-render unnecessarily', () => {\n      const renderSpy = jest.spyOn(React, 'createElement');\n      \n      const { rerender } = render(\n        <TestWrapper>\n          <ReceivingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      const initialRenderCount = renderSpy.mock.calls.length;\n\n      // Re-render with same props\n      rerender(\n        <TestWrapper>\n          <ReceivingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      // Should not cause unnecessary re-renders\n      expect(renderSpy.mock.calls.length - initialRenderCount).toBeLessThan(10);\n    });\n\n    it('should handle large file uploads without blocking UI', async () => {\n      const user = userEvent.setup();\n      \n      render(\n        <TestWrapper>\n          <ReceivingAuditModal {...defaultProps} />\n        </TestWrapper>\n      );\n\n      const photoInput = screen.getByLabelText(/upload photos/i);\n      const largeFile = new File(['x'.repeat(1024 * 1024)], 'large-photo.jpg', { type: 'image/jpeg' });\n      \n      await user.upload(photoInput, largeFile);\n\n      // Should show progress indicator\n      expect(screen.getByText(/processing/i)).toBeInTheDocument();\n    });\n  });\n});